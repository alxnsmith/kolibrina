<!DOCTYPE html>

<html lang="ru">
	<head>
        {% load static %}
		<meta charset="UTF-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<meta name="robots" content="index,follow">

			<title>КОЛИБРИНА - ЧАТ | Общение</title>

		<meta name="description" content="">

        {% include 'main/headPiece.html' %}

        <link rel="stylesheet" href="{% static 'css/fonts.css' %}">
		<link rel="stylesheet" href="{% static 'css/pages/chat.css' %}">

		<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->

	    <!--[if lt IE 9]>
	      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	    <![endif]-->
	</head>
	<body>

		{% include "main/header.html"%}

		<div class="container">
			<div class="row">
				<div class="col-sm-9 col-md-9 col-lg-9">
					<div id="wrapper-chat">
						<div class="wrapper-messages">

                        </div>
					</div>
					<form action="" method="POST" id="chat-userPanel">
						<textarea name="" id="mes" placeholder="Введите сообщение..."></textarea>
						<a onclick="web_send_msg()" id="tosend">Отправить</a>
						<div class="clear"></div>
					</form>
				</div>
				<div class="col-sm-3 col-md-3 col-lg-3">
					{% include "main/banner.html"%}
				</div>
			</div>
		</div>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" ></script>
    <script type="text/javascript" src="https://comet-server.ru/CometServerApi.js" ></script>
    <link rel="stylesheet" type="text/css" href="https://comet-server.ru/doc/html_chat.css"></link>
        <script>
            var htmljs_Chat_timer = new Date();
            var htmljs_Chat_masgArray = {};

            function web_send_msg()
            {
                // Получение значений из элементов ввода.
                var text = $("#mes").val();
                var name = '{{ request.user }}'

                // Очистка формы
                $("#mes").val("");

                // Зпишем время в момент отправки сообщения
                htmljs_Chat_timer = new Date();


                // Добавление отправленного сообщения к списку сообщений.
                $(".wrapper-messages").append('<div class="wrapper-messages__item my-message"><div class="message">'+htmljs_Chat_HtmlEncode(text)+'</div><div class="date">'+String(htmljs_Chat_timer.getDate()).padStart(2, '0')+'.'+String(htmljs_Chat_timer.getMonth()).padStart(2, '0')+'.'+htmljs_Chat_timer.getFullYear()+'</div></div>');

                // Прокрутка списка сообщений в низ
                $("#wrapper-chat").animate({ scrollTop: $("#wrapper-chat")[0].scrollHeight}, "slow");

                // Используем случайное число чтоб нечайно не всавить два раза одно и тоже сообщение
                var randomId = ""+Math.floor(Math.random()*10) + "" + (Math.random()*10) + "" + (Math.random()*10) + "" + (Math.random()*10);
                randomId = randomId.replace(/[^0-9]/img, "");

                htmljs_Chat_masgArray[randomId] = true;

                // Отправка сообщения в канал чата
                CometServer().web_pipe_send("web_chat_pipe.msg", {"text":text, "name":name, "randomId":randomId});

                // Уведомим остальные вкладки о том что мы добавили сообщение в чат
                comet_server_signal().send_emit("AddToChat", {"text":text, "name":name, "randomId":randomId});
            }


            // Функция выполнится в после загрузки страницы
            function htmljs_Chat_Init( holder )
            {
                // Подписываемся на канал в который и будут отпавлятся сообщения чата.
                CometServer().subscription("web_chat_pipe.msg", function(msg){
                    console.log(["msg", msg]);

                    if(!msg.data.randomId)
                    {
                        // Сообщение какоето не правильное, не имеющие randomId
                        return;
                    }

                    msg.data.randomId = ""+msg.data.randomId;
                    msg.data.randomId.replace(/[^0-9]/img, "");

                    if(htmljs_Chat_masgArray[msg.data.randomId] && !msg.data.history)
                    {
                        // Сообщение уже вставлено
                        return;
                    }

                    if(!msg.data.history)
                    {
                        htmljs_Chat_masgArray[msg.data.randomId] = true;
                    }

                    // Добавление полученого сообщения к списку сообщений.
                    $(".wrapper-messages").append('<div class="wrapper-messages__item friend-message"><div class="name">'+htmljs_Chat_HtmlEncode(msg.data.name)+'</div><div class="message">'+htmljs_Chat_HtmlEncode(msg.data.text)+'</div><div class="date">'+String(htmljs_Chat_timer.getDate()).padStart(2, '0')+'.'+String(htmljs_Chat_timer.getMonth()).padStart(2, '0')+'.'+htmljs_Chat_timer.getFullYear()+'</div></div>');

                    // Прокрутка списка сообщений в низ
                    $("#wrapper-chat").animate({ scrollTop: $("#wrapper-chat")[0].scrollHeight}, "slow");
                });

                // Подписываемся на событие добавления сообщения в чат нами, для того чтобы если чат открыт в нескольких вкладках
                // наше сообщение добавленое на одной вкладке отобразилось на всех остальных без перезагрузки страницы
                comet_server_signal().connect("AddToChat", function(msg){
                    console.log(["msg", msg]);

                    if(htmljs_Chat_masgArray[msg.randomId])
                    {
                        // Сообщение уже вставлено
                        return;
                    }

                    htmljs_Chat_masgArray[msg.randomId] = true;

                    // Добавление полученого сообщения к списку сообщений.
                    $("#wrapper-chat").append("<p><b>"+htmljs_Chat_HtmlEncode(msg.name)+": </b>"+htmljs_Chat_HtmlEncode(msg.text)+"</p>");

                    // Прокрутка списка сообщений в низ
                    $("#wrapper-chat").animate({ scrollTop: $("#wrapper-chat")[0].scrollHeight}, "slow");
                });

                // Подписываемся на канал в который и будут отпавлятся уведомления о доставке отправленых сообщений.
                CometServer().subscription("#web_chat_pipe", function(p)
                {
                    // Зпишем время в момент получения отчёта о доставке сообщения
                    var etime = new Date();

                    console.log(["answer_to_web_chat_pipe", p]);
                    $("#answer").html("Сообщение доставлено "+p.data.number_messages+" получателям за "+ (etime.getTime() - htmljs_Chat_timer.getTime() )+"ms");
                    if(p.data.error!= "") $("#answer").html(" "+p.data.error);

                    // Прокрутка списка сообщений в низ
                    $("#wrapper-chat").animate({ scrollTop: $("#wrapper-chat")[0].scrollHeight}, "slow");
                });

                CometServer().subscription("chatControl.clean", function(event){
                    console.log("Мы получили команду очистить чат");
                    $("#wrapper-chat").html( '' );

                    // Прокрутка списка сообщений в низ
                    $("#wrapper-chat").animate({ scrollTop: $("#wrapper-chat")[0].scrollHeight}, "slow");
                });

                // Просим отправить последние сообщения которые были отправлены в канал. Это позволит загрузить историю сообщений в чат.
                CometServer().get_pipe_log('web_chat_pipe');
            }


            function htmljs_Chat_HtmlEncode(s)
            {
              var el = document.createElement("div");
              el.innerText = el.textContent = s;
              s = el.innerHTML;
              return s;
            }

        </script>
    <div id="html-chat"></div>
    <style>
        .holder-html-chat{ border: 1px solid #ccc;padding:10px;background-color: #fff;width: 600px;}
        .html-chat-history{ max-width: 600px; overflow: auto;max-height: 900px; border: 1px solid #ccc;padding: 5px;}
        .html-chat-js-name{ margin-top:10px; }
        .html-chat-js-input{ max-width: 600px;max-height: 100px;width: 600px;margin-top:10px; }
        .html-chat-js-button-holder{ margin-bottom: 0px;margin-top: 10px; }
        .html-chat-js-button-holder input{ width: 220px; }
        .html-chat-js-answer{ float:right; }
        .html-chat-js-answer a{ color: #777;font-size: 12px; font-family: cursive;}
        .html-chat-js-answer a:hover{ color: #338;font-size: 12px; font-family: cursive;}
        .html-chat-msg{ margin: 0px; }
    </style>

<script>
    $(document).ready(function() {
        CometServer().start({dev_id: 3139 })
        htmljs_Chat_Init( $("#html-chat") )
    });
</script>





		<div class="mt20"></div>
		{% include "main/footer.html"%}

		<script>
			$(document).ready(function() {
				$("header nav a:nth-child(6) > span").addClass("select");
				$(".title > h2 > strong").html("ЧАТ | Общение");
			});
		</script>
	</body>
</html>