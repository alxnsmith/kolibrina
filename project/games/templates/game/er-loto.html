<!DOCTYPE html>

<html lang="ru">
	<head>
        {% load static %}
		<meta charset="UTF-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<meta name="robots" content="index,follow">

			<title>КОЛИБРИНА - Турнир Недели</title>

		<meta name="description" content="">
		
		{% include 'main/headPiece.html' %}

		<link rel="stylesheet" href="{% static "css/style.css" %}">
		<link rel="stylesheet" href="{% static "css/pages/er-loto.css" %}">
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	    
	    <!--[if lt IE 9]>
	      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	    <![endif]-->
	</head>
	<body>

		{% include "main/header.html"%}

		<div class="container">

			<div class="marafon-top">
				<div class="text-information">
					<p>Текстовая информация</p>
				</div>
				<div class="marafon-top_right">
					<div id="timer" class="marafon-timer">:</div>
				</div>
			</div>

			{% include 'game/blocks/tornament_user_info.html' %}

			{% include 'game/blocks/quest_nums.html' %}

            {% include 'game/blocks/el_game_nav.html' %}


			<div class="estimate-author">
				<span>Оцените автора: </span>
				<a href="#">0</a>
				<a href="#">1</a>
				<a href="#">2</a>
				<a href="#">3</a>
				<a href="#">4</a>
				<a href="#">5</a>
				<a href="#">6</a>
				<a href="#">7</a>
				<a href="#">8</a>
				<a href="#">9</a>
				<a href="#">10</a>
			</div>

		</div>

		{% include "main/footer.html"%}
        <script>
			$(document).ready(function() {
				$("header nav a:nth-child(2) > span").addClass("select");
				$(".title > h2 > strong").html("Тренировка Эрудит-Лото / Турнир Недели");
			});
		</script>
        <script src="{% static 'js/game/render_question.js' %}"></script>
        <script src="{% static 'js/game/timer.js' %}"></script>
        <script src="{% static 'js/game/calculate_and_render_tournament_score.js' %}"></script>

        <script>
            function main(){
                let elem_timer = document.getElementById('timer')
                let round_timer
                let tournament_author
                let question_text
                const t = "TWEL"
                let old_answers = ['______', '______', '______', '______']
                const tournament_socket = new WebSocket(
                    'ws://' + window.location.host + `/ws/tournament-week-${t}/`
                );
                tournament_socket.onmessage = (event) => {
                    let data = JSON.parse(event.data)
                    if (data.type === 'timer_duration') {
                        round_timer = new timer(data.timer, elem_timer)
                    } else if (data.type === 'question') {
                        question_text = data.question.question
                        render_question(question_text, data.question.answers, old_answers, data.question_num)
                        old_answers = data.question.answers
                    } else if (data.type === 'tournament_author') {
                        tournament_author = data.author
                        document.getElementById('tournament_author').innerText = tournament_author
                    } else if (data.type === 'reset_timer') {
                        round_timer.stop()
                        round_timer.rearm_timer()
                    } else if (data.type === 'answer_result') {
                        console.log(data)
                        if (data.result === 'OK'){
                            round_timer.start()
                        } else {
                            window.location.replace('{% url 'result-game' %}'+
                                `?status=lose_tournament_week`+
                                `&score=0`+
                                `&time=${encodeURI(round_timer.timer_value())}`+
                                `&author=${encodeURI(tournament_author)}`+
                                `&correct_answer=${encodeURI(data.correct_answer)}`+
                                `&attempt=3`+
                                `&question=${encodeURI(question_text)}`
                            )
                        }
                    }



                }
                tournament_socket.onclose = function (e) {
                    console.error('Online socket closed unexpectedly.', e);
                };

                function start_game(){
                    tournament_socket.send(JSON.stringify({
                    'event': 'start_game',
                    }))
                    round_timer.start()
                }

            document.getElementById('start_game').onclick = (event)=>{  {# start game and get first question #}
                let start_banner = event.target.parentElement
                start_banner.style.opacity = '0'
                start_banner.style.zIndex = '-10'
                start_game()
            }
            document.getElementById('respond').onclick = (event)=>{  {# get and send answer #}
                let answer = document.querySelectorAll('.answer input')
                for (let i=0; i<answer.length; i++){
                    if (answer[i].checked){
                        answer = answer[i].value
                        break
                    }
                }
                tournament_socket.send(JSON.stringify({
                    'event': 'respond',
                    'answer': answer
                }))
            }
            }
            main()
        </script>
	</body>
</html>