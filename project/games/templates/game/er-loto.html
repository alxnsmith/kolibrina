<!DOCTYPE html>

<html lang="ru">
	<head>
        {% load static %}
		<meta charset="UTF-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<meta name="robots" content="index,follow">

			<title>КОЛИБРИНА - Турнир Недели</title>

		<meta name="description" content="">
		
		{% include 'main/headPiece.html' %}

		<link rel="stylesheet" href="{% static "css/style.css" %}">
		<link rel="stylesheet" href="{% static "css/pages/er-loto.css" %}">
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	    
	    <!--[if lt IE 9]>
	      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	    <![endif]-->
	</head>
	<body>

		{% include "main/header.html"%}

		<div class="container">

			<div class="marafon-top">
				<div class="text-information">
					<p>Текстовая информация</p>
				</div>
				<div class="marafon-top_right">
					<div id="timer" class="marafon-timer">:</div>
				</div>
			</div>

			<div class="user-stat">
				<div class="user-avatar user_div">
					<div class="user_img">{% if AvatarImage != False %}<img class="user_img" src="{{ AvatarImage }}" alt="">{% endif %}</div>
					<div class="user-name">
						<span>{{ request.user.lastName }}</span>
						<span>{{ request.user.firstName }}</span>
						<span><b>г.{{ request.user.city }}</b></span>
					</div>
				</div>
				<div class="user-points user_div">
					<span class="points-title">Баллы</span>
					<div class="user-points_points">
						<div class="per-game points_block">
							<div class="points_block-title">за игру</div>
							<div id="points_per_game" class="points_block-points">00</div>
						</div>
						<div class="per-game points_block">
							<div class="points_block-title">за месяц</div>
							<div id="points_per_month" class="points_block-points">{{ month_score }}</div>
						</div>
						<div class="per-game points_block">
							<div class="points_block-title">всего</div>
							<div id="points_in_total" class="points_block-points">00</div>
						</div>
					</div>
				</div>
				<div class="league_place user_div">
					<span><b>Место <br>в лиге</b></span>
					<div class="league_count">123 / 878</div>
				</div>
				<div class="author user_div marafon_author">
					<span class="marafon_author-title">Автор турнира</span>
					<span class="marafon_author-name">Сергей Задорожный, Москва</span>
				</div>

				<div class="marafon_league">
					<span style="color: #B658B0;">{{ league }}</span>

				</div>
				<div class="user-lvl user_div">
					<span>Уровень игрока</span>
					<div class="lvl">{{ level.level }} / {{ level.numLevel }}</div>
				</div>
			</div>

			{% include 'game/blocks/quest_nums.html' %}

            {% include 'game/blocks/el_game_nav.html' %}


			<div class="estimate-author">
				<span>Оцените автора: </span>
				<a href="#">0</a>
				<a href="#">1</a>
				<a href="#">2</a>
				<a href="#">3</a>
				<a href="#">4</a>
				<a href="#">5</a>
				<a href="#">6</a>
				<a href="#">7</a>
				<a href="#">8</a>
				<a href="#">9</a>
				<a href="#">10</a>
			</div>

		</div>

		{% include "main/footer.html"%}
        <script>
			$(document).ready(function() {
				$("header nav a:nth-child(2) > span").addClass("select");
				$(".title > h2 > strong").html("Тренировка Эрудит-Лото / Турнир Недели");
			});
		</script>

        <script>
            function init_points_in_total() {
                document.getElementById('points_in_total').innerText =
                    parseInt(document.getElementById('points_per_game').innerText) + parseInt(document.getElementById('points_per_month').innerText)}
            init_points_in_total()
        </script>

        <script>
            function main(){
                let elem_timer = document.getElementById('timer')

                class timer {
                    timer

                    constructor(time, element) {
                        self.duration = time
                        self.elem_timer = element
                        this.rearm_timer()
                    }

                    minutes() {
                        return `${Math.floor(self.time / 60)}`.padStart(2, '0')
                    }

                    seconds() {
                        return `${self.time % 60}`.padStart(2, '0')
                    }

                    timer_value() {
                        return `${this.minutes()}:${this.seconds()}`
                    }

                    rearm_timer() {
                        self.time = self.duration
                        self.elem_timer.innerText = this.timer_value()
                    }

                    stop() {
                        clearInterval(self.timer)
                    }

                    start() {
                        self.timer = setInterval(() => {
                            if (self.time > 0) {
                                self.elem_timer.innerText = this.timer_value()
                                self.time--
                            }
                        }, 1000)
                    }
                }

                let round_timer
                const t = "TWEL"
                const tournament_socket = new WebSocket(
                    'ws://' + window.location.host + `/ws/tournament-week-${t}/`
                );
                tournament_socket.onmessage = (e) => {
                    let data = JSON.parse(e.data)
                    if (data.type === 'send_timer_duration') {
                        round_timer = new timer(data.timer, elem_timer)


                    }


                }
                tournament_socket.onclose = function (e) {
                    console.error('Online socket closed unexpectedly.', e);
                };

            document.getElementById('start_game').onclick = (event)=>{
                let start_banner = event.target.parentElement
                start_banner.style.opacity = '0'
                start_banner.style.zIndex = '-10'
                tournament_socket.send(JSON.stringify({
                    'event': 'start_game',
                    }))
                round_timer.start()
            }

            }
            main()
        </script>
	</body>
</html>